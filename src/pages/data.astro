---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="data">
  <h1 class="text-3xl font-bold mb-4">Data Pengguna</h1>
  <div class="mb-4 flex gap-4 items-center">
    <input
      type="text"
      id="searchInput"
      placeholder="Cari nama atau email..."
      class="px-4 py-2 border rounded w-full max-w-md shadow-sm"
    />
    <button
      onclick="resetSearch()"
      class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm"
    >
      Reset
    </button>
    <button
      onclick="exportToExcel()"
      class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm"
    >
      Export Excel
    </button>
  </div>
  <div id="loading" class="text-blue-600 mb-4">⏳ Memuat data...</div>
  <div class="mb-4 flex items-center gap-2">
    <label for="pageSize" class="text-sm font-medium">Tampilkan</label>
    <select id="pageSize" class="border px-2 py-1 rounded text-sm">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
    <span class="text-sm">baris per halaman</span>
  </div>
  <table
    class="min-w-full bg-white border border-gray-300 hidden"
    id="userTable"
  >
    <thead class="bg-blue-100">
      <tr>
        <th class="border px-4 py-2 text-left">ID</th>
        <th class="border px-4 py-2 text-left">Nama</th>
        <th class="border px-4 py-2 text-left">Email</th>
        <th class="border px-4 py-2 text-left">Aksi</th>
      </tr>
    </thead>
    <tbody id="data-table-body">
      <!-- Data baris diisi oleh JS -->
    </tbody>
  </table>

  <!-- Pindahkan ke luar dari tbody -->
  <div class="flex justify-between items-center mt-4 gap-2">
    <button
      id="btnPrev"
      onclick="prevPage()"
      class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded disabled:opacity-50"
      >Prev</button
    >

    <span id="page-info" class="text-sm text-gray-700"></span>

    <button
      id="btnNext"
      onclick="nextPage()"
      class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded disabled:opacity-50"
      >Next</button
    >
  </div>

  <script>
    let pageSize = 10;
    let currentPage = 1;
    let dataList = [];
    let filteredList = [];
    let searchTerm = "";

    async function fetchData() {
      const loading = document.getElementById("loading");
      loading.classList.remove("hidden");
      try {
        const res = await fetch("https://dummyjson.com/users");
        const json = await res.json();
        dataList = json.users;
        renderTable();
      } catch (err) {
        loading.textContent = "❌ Gagal memuat data.";
      } finally {
        loading.classList.add("hidden");
      }
    }

    function renderTable() {
      const list = searchTerm ? filteredList : dataList;
      const totalPages = Math.ceil(list.length / pageSize);

      // pastikan currentPage tidak melebihi totalPages
      if (currentPage > totalPages) currentPage = totalPages || 1;

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = list.slice(start, end);

      const rows = pageData
        .map(
          (user) => `
      <tr class="hover:bg-blue-50 transition">
        <td class="px-6 py-4 border-b border-gray-200">${user.id}</td>
        <td class="px-6 py-4 border-b border-gray-200">${user.firstName} ${user.lastName}</td>
        <td class="px-6 py-4 border-b border-gray-200">${user.email}</td>
        <td class="px-6 py-4 border-b border-gray-200">
          <button onclick="showDetail(${user.id})"
            class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
            Detail
          </button>
        </td>
      </tr>`
        )
        .join("");

      document.getElementById("data-table-body").innerHTML = rows;
      document.getElementById("page-info").textContent =
        `Page ${currentPage} of ${totalPages}`;

      document.getElementById("btnPrev").disabled = currentPage === 1;
      document.getElementById("btnNext").disabled = currentPage === totalPages;
      document.getElementById("userTable").classList.remove("hidden");
    }

    function nextPage() {
      const list = searchTerm ? filteredList : dataList;
      const totalPages = Math.ceil(list.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    function showDetail(id) {
      const user = dataList.find((u) => u.id === id);
      if (!user) return;

      const detailBox = document.getElementById("detail-box");
      const detailContent = document.getElementById("detail-content");
      detailContent.innerHTML = `
      <p><strong>Nama:</strong> ${user.firstName} ${user.lastName}</p>
      <p><strong>Email:</strong> ${user.email}</p>
      <p><strong>Phone:</strong> ${user.phone}</p>
      <p><strong>Gender:</strong> ${user.gender}</p>
      <p><strong>Alamat:</strong> ${user.address.address}, ${user.address.city}</p>
      <p><strong>Perusahaan:</strong> ${user.company.name}</p>
    `;
      detailBox.classList.remove("hidden");
    }

    function resetSearch() {
      document.getElementById("searchInput").value = "";
      searchTerm = "";
      currentPage = 1;
      renderTable();
    }

    document.getElementById("searchInput").addEventListener("input", (e) => {
      searchTerm = e.target.value.trim().toLowerCase();
      filteredList = dataList.filter(
        (u) =>
          `${u.firstName} ${u.lastName}`.toLowerCase().includes(searchTerm) ||
          u.email.toLowerCase().includes(searchTerm)
      );
      currentPage = 1;
      renderTable();
    });

    document.getElementById("pageSize").addEventListener("change", (e) => {
      pageSize = parseInt(e.target.value, 10);
      currentPage = 1;
      renderTable();
    });

    window.nextPage = nextPage;
    window.prevPage = prevPage;
    window.showDetail = showDetail;

    window.addEventListener("DOMContentLoaded", fetchData);
  </script>
</BaseLayout>
